<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Book Appointment</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            -webkit-font-smoothing: antialiased;
        }
        #root {
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const config = {
            contractorId: params.get('contractor'),
            primaryColor: params.get('color') || '#10b981',
            services: params.get('services')?.split(',').filter(Boolean) || []
        };

        // Validate
        if (!config.contractorId) {
            document.getElementById('root').innerHTML = '<div style="padding:40px;text-align:center;color:#dc2626">Missing contractor ID</div>';
            throw new Error('Missing contractor ID');
        }

        // API base URL
        const API_BASE = window.location.origin;

        // Notify parent of height changes
        function notifyResize() {
            const height = document.body.scrollHeight;
            window.parent.postMessage({
                source: 'krib-widget',
                type: 'resize',
                height: height
            }, '*');
        }

        // Notify booking complete
        function notifyBookingComplete(booking) {
            window.parent.postMessage({
                source: 'krib-widget',
                type: 'booking-complete',
                booking: booking
            }, '*');
        }

        // Observe height changes
        const resizeObserver = new ResizeObserver(notifyResize);
        resizeObserver.observe(document.body);

        // State
        let state = {
            step: 'service',
            loading: true,
            error: null,
            contractor: null,
            availability: null,
            selectedService: null,
            selectedDate: null,
            selectedTime: null,
            formData: { name: '', email: '', phone: '', address: '', description: '', referralSource: '' },
            submitting: false,
            booking: null,
            calendarMonth: new Date()
        };

        // DOM references
        const root = document.getElementById('root');

        // Utility functions
        function formatTime(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            const ampm = h >= 12 ? 'PM' : 'AM';
            return `${h % 12 || 12}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        function getDateString(date) {
            return date.toISOString().split('T')[0];
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        // API calls
        async function loadContractor() {
            const res = await fetch(`${API_BASE}/api/widget/contractor-info?contractorId=${config.contractorId}`);
            if (!res.ok) throw new Error((await res.json()).error || 'Failed to load');
            return res.json();
        }

        async function loadAvailability(startDate, endDate) {
            const res = await fetch(`${API_BASE}/api/widget/availability?contractorId=${config.contractorId}&startDate=${startDate}&endDate=${endDate}`);
            if (!res.ok) return null;
            return res.json();
        }

        async function submitBooking(data) {
            const res = await fetch(`${API_BASE}/api/widget/book`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if (!res.ok) throw new Error(json.error || 'Booking failed');
            return json;
        }

        // Render functions
        function render() {
            const theme = {
                primary: config.primaryColor,
                primaryLight: adjustColor(config.primaryColor, 40)
            };

            let html = '';

            if (state.loading) {
                html = `<div style="display:flex;align-items:center;justify-content:center;min-height:400px">
                    <div style="width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:${theme.primary};border-radius:50%;animation:spin 1s linear infinite"></div>
                </div>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>`;
            } else if (state.error && !state.contractor) {
                html = `<div style="padding:40px;text-align:center;color:#dc2626">
                    <p>${state.error}</p>
                    <button onclick="init()" style="margin-top:16px;padding:10px 20px;background:${theme.primary};color:#fff;border:none;border-radius:8px;cursor:pointer">Retry</button>
                </div>`;
            } else {
                html = renderWidget(theme);
            }

            root.innerHTML = html;
            notifyResize();
            bindEvents();
        }

        function renderWidget(theme) {
            const c = state.contractor;
            const cust = c?.customization || {};

            let html = `
            <div style="background:#fff;border-radius:16px;overflow:hidden">
                <!-- Header -->
                <div style="padding:20px;background:${theme.primary};color:#fff;display:flex;align-items:center;gap:12px">
                    ${c?.logoUrl ? `<img src="${c.logoUrl}" style="width:48px;height:48px;border-radius:8px;object-fit:cover">` : ''}
                    <div style="flex:1">
                        <div style="font-size:18px;font-weight:600">${cust.headerText || 'Schedule Service'}</div>
                        <div style="font-size:14px;opacity:0.9">${c?.companyName || ''}</div>
                    </div>
                    ${c?.averageRating ? `<div style="background:rgba(255,255,255,0.2);padding:6px 10px;border-radius:20px;font-size:14px">★ ${c.averageRating}</div>` : ''}
                </div>

                ${state.step !== 'confirm' ? renderProgress(theme) : ''}

                ${state.error ? `<div style="margin:16px;padding:12px 16px;background:#fef2f2;color:#dc2626;border-radius:8px;display:flex;justify-content:space-between;font-size:14px">${state.error}<button onclick="clearError()" style="border:none;background:none;cursor:pointer;font-size:18px">&times;</button></div>` : ''}

                <div style="padding:24px">
                    ${state.step === 'service' ? renderServiceStep(theme) : ''}
                    ${state.step === 'date' ? renderDateStep(theme) : ''}
                    ${state.step === 'time' ? renderTimeStep(theme) : ''}
                    ${state.step === 'details' ? renderDetailsStep(theme) : ''}
                    ${state.step === 'confirm' ? renderConfirmStep(theme) : ''}
                </div>

                ${state.step !== 'service' && state.step !== 'confirm' ? `
                <div style="padding:0 24px 16px">
                    <button onclick="goBack()" style="padding:12px 20px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">← Back</button>
                </div>` : ''}

                <div style="text-align:center;padding:12px;border-top:1px solid #f3f4f6;font-size:12px;color:#9ca3af">
                    Powered by <a href="https://mykrib.app" target="_blank" style="color:#6b7280;text-decoration:none;font-weight:500">Krib</a>
                </div>
            </div>`;

            return html;
        }

        function renderProgress(theme) {
            const steps = ['service', 'date', 'time', 'details'];
            const stepLabels = ['Service', 'Date', 'Time', 'Details'];
            const currentIndex = steps.indexOf(state.step);

            return `<div style="display:flex;padding:16px 24px;border-bottom:1px solid #e5e7eb;gap:8px">
                ${steps.map((s, i) => {
                    const isActive = i === currentIndex;
                    const isCompleted = i < currentIndex;
                    const dotStyle = isActive ? `background:${theme.primary};box-shadow:0 0 0 4px ${theme.primaryLight}` :
                        isCompleted ? `background:${theme.primary}` : 'background:#e5e7eb';
                    const labelStyle = (isActive || isCompleted) ? 'color:#374151' : 'color:#9ca3af';
                    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:6px">
                        <div style="width:10px;height:10px;border-radius:50%;${dotStyle}"></div>
                        <span style="font-size:11px;font-weight:500;${labelStyle}">${stepLabels[i]}</span>
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderServiceStep(theme) {
            const services = state.contractor?.serviceTypes || [];
            return `<h3 style="margin:0 0 20px;font-size:18px;font-weight:600">What service do you need?</h3>
            <div style="display:grid;gap:12px">
                ${services.map(s => {
                    const isSelected = state.selectedService?.id === s.id;
                    const style = isSelected ? `border-color:${theme.primary};background:${theme.primaryLight}` : '';
                    return `<button onclick="selectService('${s.id}')" style="display:flex;justify-content:space-between;padding:16px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:12px;cursor:pointer;text-align:left;${style}">
                        <span style="font-weight:500;color:#111827">${s.name}</span>
                        ${s.duration ? `<span style="font-size:13px;color:#6b7280">~${s.duration} min</span>` : ''}
                    </button>`;
                }).join('')}
            </div>`;
        }

        function renderDateStep(theme) {
            const month = state.calendarMonth;
            const year = month.getFullYear();
            const m = month.getMonth();
            const firstDay = new Date(year, m, 1).getDay();
            const daysInMonth = new Date(year, m + 1, 0).getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + (state.contractor?.booking?.maxAdvanceDays || 30));

            const canPrev = new Date(year, m, 1) > today;
            const canNext = new Date(year, m + 1, 1) <= maxDate;

            let days = [];
            for (let i = 0; i < firstDay; i++) days.push('');
            for (let i = 1; i <= daysInMonth; i++) days.push(i);

            return `<h3 style="margin:0 0 20px;font-size:18px;font-weight:600">Select a date</h3>
            <div style="background:#f9fafb;border-radius:12px;padding:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <button onclick="prevMonth()" ${!canPrev ? 'disabled' : ''} style="width:32px;height:32px;border:none;background:#fff;border-radius:8px;cursor:pointer;${!canPrev ? 'opacity:0.3' : ''}">&lt;</button>
                    <span style="font-weight:600">${month.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                    <button onclick="nextMonth()" ${!canNext ? 'disabled' : ''} style="width:32px;height:32px;border:none;background:#fff;border-radius:8px;cursor:pointer;${!canNext ? 'opacity:0.3' : ''}">&gt;</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:8px">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<span style="font-size:12px;font-weight:500;color:#6b7280;padding:8px 0">${d}</span>`).join('')}
                </div>
                <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px">
                    ${days.map(day => {
                        if (!day) return '<div></div>';
                        const dateStr = `${year}-${String(m + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const date = new Date(year, m, day);
                        const avail = state.availability?.slots?.[dateStr];
                        const available = avail?.available && date >= today && date <= maxDate;
                        const isSelected = dateStr === state.selectedDate;

                        let style = 'aspect-ratio:1;display:flex;align-items:center;justify-content:center;border:none;border-radius:8px;font-size:14px;position:relative;';
                        if (isSelected) {
                            style += `background:${theme.primary};color:#fff;cursor:pointer;font-weight:600;`;
                        } else if (available) {
                            style += 'background:#fff;color:#111827;cursor:pointer;font-weight:500;';
                        } else {
                            style += 'background:transparent;color:#9ca3af;cursor:default;';
                        }

                        return `<button onclick="${available ? `selectDate('${dateStr}')` : ''}" style="${style}" ${!available ? 'disabled' : ''}>
                            ${day}
                            ${avail?.availableCount ? `<span style="position:absolute;bottom:2px;right:2px;font-size:9px;background:${theme.primary};color:#fff;width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center">${avail.availableCount}</span>` : ''}
                        </button>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderTimeStep(theme) {
            const dayData = state.availability?.slots?.[state.selectedDate];
            const slots = dayData?.slots?.filter(s => s.available) || [];

            if (!slots.length) {
                return `<h3 style="margin:0 0 20px;font-size:18px;font-weight:600">Select a time</h3>
                <p style="text-align:center;color:#6b7280;padding:32px 16px;background:#f9fafb;border-radius:12px">No available times for this date.</p>`;
            }

            return `<h3 style="margin:0 0 20px;font-size:18px;font-weight:600">Select a time for ${dayData?.dayLabel}</h3>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
                ${slots.map(slot => {
                    const isSelected = state.selectedTime?.start === slot.start;
                    const style = isSelected ? `background:${theme.primary};border-color:${theme.primary};color:#fff` : 'background:#fff;border-color:#e5e7eb;color:#374151';
                    return `<button onclick="selectTime('${slot.start}')" style="padding:12px 8px;border:2px solid;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;${style}">${slot.startDisplay}</button>`;
                }).join('')}
            </div>`;
        }

        function renderDetailsStep(theme) {
            const f = state.formData;
            const requirePhone = state.contractor?.booking?.requirePhone;
            const requireAddress = state.contractor?.booking?.requireAddress;

            return `<h3 style="margin:0 0 20px;font-size:18px;font-weight:600">Your information</h3>
            <div style="background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:24px">
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb"><span style="color:#6b7280;font-size:14px">Service</span><strong style="font-size:14px">${state.selectedService?.name}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e5e7eb"><span style="color:#6b7280;font-size:14px">Date</span><strong style="font-size:14px">${formatDate(state.selectedDate)}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:#6b7280;font-size:14px">Time</span><strong style="font-size:14px">${state.selectedTime?.startDisplay}</strong></div>
            </div>
            <form onsubmit="handleSubmit(event)">
                <div style="margin-bottom:16px">
                    <label style="display:block;font-size:14px;font-weight:500;color:#374151;margin-bottom:6px">Name *</label>
                    <input type="text" name="name" value="${f.name}" oninput="updateForm(event)" required style="width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px" placeholder="Your full name">
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;font-size:14px;font-weight:500;color:#374151;margin-bottom:6px">Email *</label>
                    <input type="email" name="email" value="${f.email}" oninput="updateForm(event)" required style="width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px" placeholder="your@email.com">
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;font-size:14px;font-weight:500;color:#374151;margin-bottom:6px">Phone ${requirePhone ? '*' : '(optional)'}</label>
                    <input type="tel" name="phone" value="${f.phone}" oninput="updateForm(event)" ${requirePhone ? 'required' : ''} style="width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px" placeholder="(555) 555-5555">
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;font-size:14px;font-weight:500;color:#374151;margin-bottom:6px">Service Address ${requireAddress ? '*' : '(optional)'}</label>
                    <input type="text" name="address" value="${f.address}" oninput="updateForm(event)" ${requireAddress ? 'required' : ''} style="width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px" placeholder="123 Main St, City, State ZIP">
                </div>
                <div style="margin-bottom:16px">
                    <label style="display:block;font-size:14px;font-weight:500;color:#374151;margin-bottom:6px">Describe the issue (optional)</label>
                    <textarea name="description" oninput="updateForm(event)" style="width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px;resize:vertical;min-height:80px" placeholder="Please describe what you need help with...">${f.description}</textarea>
                </div>
                <div style="margin-bottom:24px">
                    <label style="display:block;font-size:14px;font-weight:500;color:#374151;margin-bottom:6px">How did you hear about us? (optional)</label>
                    <select name="referralSource" onchange="updateForm(event)" style="width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:15px;background:#fff">
                        <option value="">Select...</option>
                        <option value="google" ${f.referralSource === 'google' ? 'selected' : ''}>Google Search</option>
                        <option value="referral" ${f.referralSource === 'referral' ? 'selected' : ''}>Friend/Family Referral</option>
                        <option value="social" ${f.referralSource === 'social' ? 'selected' : ''}>Social Media</option>
                        <option value="yelp" ${f.referralSource === 'yelp' ? 'selected' : ''}>Yelp</option>
                        <option value="other" ${f.referralSource === 'other' ? 'selected' : ''}>Other</option>
                    </select>
                </div>
                <button type="submit" ${state.submitting ? 'disabled' : ''} style="width:100%;padding:14px 24px;background:${theme.primary};color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;${state.submitting ? 'opacity:0.5' : ''}">
                    ${state.submitting ? 'Booking...' : 'Confirm Booking'}
                </button>
            </form>`;
        }

        function renderConfirmStep(theme) {
            const b = state.booking;
            return `<div style="text-align:center;padding:16px 0">
                <div style="width:64px;height:64px;border-radius:50%;background:${theme.primaryLight};color:${theme.primary};display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 20px">✓</div>
                <h3 style="font-size:24px;margin-bottom:8px">Booking Confirmed!</h3>
                <p style="color:#6b7280;margin-bottom:24px">Thank you for booking with ${b?.companyName}</p>
                <div style="background:#f9fafb;border-radius:12px;padding:20px;text-align:left;margin-bottom:20px">
                    <div style="text-align:center;padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid #e5e7eb">
                        <span style="display:block;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Confirmation Code</span>
                        <strong style="font-size:28px;letter-spacing:2px;color:#111827">${b?.confirmationCode}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:#6b7280;font-size:14px">Service</span><strong style="font-size:14px">${b?.serviceType}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0"><span style="color:#6b7280;font-size:14px">Date & Time</span><strong style="font-size:14px;text-align:right">${formatDate(b?.scheduledDate)} at ${b?.scheduledTime}</strong></div>
                </div>
                <p style="font-size:14px;color:#6b7280">A confirmation email has been sent to <strong style="color:#111827">${b?.customerEmail}</strong></p>
            </div>`;
        }

        // Event handlers
        window.clearError = function() {
            state.error = null;
            render();
        };

        window.goBack = function() {
            const steps = ['service', 'date', 'time', 'details'];
            const idx = steps.indexOf(state.step);
            if (idx > 0) {
                state.step = steps[idx - 1];
                render();
            }
        };

        window.selectService = function(id) {
            state.selectedService = state.contractor.serviceTypes.find(s => s.id === id);
            state.step = 'date';
            render();
        };

        window.selectDate = function(dateStr) {
            state.selectedDate = dateStr;
            state.selectedTime = null;
            state.step = 'time';
            render();
        };

        window.selectTime = function(timeStr) {
            const slot = state.availability?.slots?.[state.selectedDate]?.slots?.find(s => s.start === timeStr);
            state.selectedTime = slot;
            state.step = 'details';
            render();
        };

        window.prevMonth = function() {
            const m = state.calendarMonth;
            state.calendarMonth = new Date(m.getFullYear(), m.getMonth() - 1, 1);
            loadAvailabilityForMonth();
            render();
        };

        window.nextMonth = function() {
            const m = state.calendarMonth;
            state.calendarMonth = new Date(m.getFullYear(), m.getMonth() + 1, 1);
            loadAvailabilityForMonth();
            render();
        };

        window.updateForm = function(e) {
            state.formData[e.target.name] = e.target.value;
        };

        window.handleSubmit = async function(e) {
            e.preventDefault();
            state.submitting = true;
            state.error = null;
            render();

            try {
                const result = await submitBooking({
                    contractorId: config.contractorId,
                    serviceType: state.selectedService.id,
                    date: state.selectedDate,
                    time: state.selectedTime.start,
                    customerName: state.formData.name,
                    customerEmail: state.formData.email,
                    customerPhone: state.formData.phone || null,
                    serviceAddress: state.formData.address || null,
                    description: state.formData.description || null,
                    referralSource: state.formData.referralSource || null
                });

                state.booking = result.booking;
                state.step = 'confirm';
                notifyBookingComplete(result.booking);
            } catch (err) {
                state.error = err.message;
            } finally {
                state.submitting = false;
                render();
            }
        };

        async function loadAvailabilityForMonth() {
            const m = state.calendarMonth;
            const startDate = getDateString(new Date(m.getFullYear(), m.getMonth(), 1));
            const endDate = getDateString(new Date(m.getFullYear(), m.getMonth() + 1, 0));
            const data = await loadAvailability(startDate, endDate);
            if (data) {
                state.availability = data;
            }
        }

        // Initialize
        async function init() {
            state.loading = true;
            state.error = null;
            render();

            try {
                state.contractor = await loadContractor();

                // Auto-select if only one service
                if (state.contractor.serviceTypes?.length === 1) {
                    state.selectedService = state.contractor.serviceTypes[0];
                    state.step = 'date';
                }

                await loadAvailabilityForMonth();
            } catch (err) {
                state.error = err.message;
            } finally {
                state.loading = false;
                render();
            }
        }

        function bindEvents() {
            // Additional event bindings if needed
        }

        init();
    </script>
</body>
</html>
