# Recurring Services Implementation Plan

## Overview
Add recurring job scheduling for services like lawn care, pest control, HVAC maintenance, etc. The system auto-generates future job instances and displays them seamlessly on both contractor and homeowner dashboards.

---

## Phase 1: Data Model & Core Logic

### 1.1 Recurring Template Collection
Create a new collection for recurring service agreements:

```
/artifacts/{appId}/public/data/recurringServices/{id}
```

**Schema:**
```javascript
{
  id: string,
  contractorId: string,
  customerId: string,           // Homeowner's userId
  propertyId: string,           // Which property

  // Service Details
  serviceName: string,          // "Lawn Care", "Pest Control", etc.
  serviceType: string,          // Category
  description: string,
  basePrice: number,
  estimatedDuration: number,    // Minutes

  // Schedule
  frequency: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'custom',
  customIntervalDays: number,   // For 'custom' frequency
  preferredDay: string,         // 'monday', 'tuesday', etc.
  preferredTime: string,        // '09:00'

  // Assignment
  assignedTechId: string,       // Same tech each time (optional)
  assignedTechName: string,

  // Status
  status: 'active' | 'paused' | 'cancelled',
  pausedUntil: timestamp,       // For temporary pause

  // Tracking
  nextScheduledDate: timestamp, // Pre-calculated next occurrence
  lastJobId: string,            // Most recent completed job
  totalCompletedJobs: number,

  // Billing (Phase 2)
  billingType: 'per_visit' | 'monthly',

  // Metadata
  createdAt: timestamp,
  updatedAt: timestamp,
  createdBy: 'contractor' | 'homeowner'
}
```

### 1.2 Job Document Extension
Add recurring fields to existing job documents:

```javascript
// Added to job/request document
{
  // ... existing fields ...

  recurring: {
    isRecurring: true,
    serviceId: string,          // Links to recurringServices doc
    instanceNumber: number,     // 1, 2, 3... occurrence number
    isAutoGenerated: true       // Distinguishes from manual jobs
  }
}
```

### 1.3 Files to Create/Modify

**New Files:**
- `src/features/recurring/lib/recurringService.js` - CRUD operations, scheduling logic
- `src/features/recurring/hooks/useRecurringServices.js` - React hooks
- `src/features/recurring/components/RecurringServiceCard.jsx` - Display card
- `src/features/recurring/components/CreateRecurringServiceModal.jsx` - Setup modal

**Modify:**
- `src/features/contractor-pro/lib/schedulingAI.js` - Add auto-generation logic
- `src/config/constants.js` - Add `RECURRING_SERVICES_COLLECTION_PATH`

---

## Phase 2: Contractor Experience

### 2.1 Creating Recurring Services
**Where:** After completing a job OR from customer profile

**Flow:**
1. Contractor completes a one-time job (e.g., lawn mowing)
2. Option appears: "Make this recurring?"
3. Simple modal:
   ```
   ┌─────────────────────────────────────────┐
   │ Set Up Recurring Service                │
   ├─────────────────────────────────────────┤
   │ Service: Lawn Mowing                    │
   │ Customer: John Smith                    │
   │                                         │
   │ Frequency: [Every 2 weeks ▾]            │
   │ Preferred Day: [Tuesday ▾]              │
   │ Price: [$75]                            │
   │                                         │
   │ [ ] Assign to same tech each time       │
   │     [Mike Johnson ▾]                    │
   │                                         │
   │ [Cancel]              [Start Service →] │
   └─────────────────────────────────────────┘
   ```

### 2.2 Managing Recurring Services
**Where:** New "Recurring" tab in ContractorProApp OR section in Customer detail

**Display:**
- List of all active recurring services
- Quick actions: Pause, Resume, Cancel, Edit
- Upcoming instances on calendar

### 2.3 Calendar Integration
- Recurring jobs show on DragDropCalendar and TeamCalendarView
- Visual indicator: Small ↻ icon on recurring job cards
- Color: Use existing job colors, add repeat badge

**Files to Modify:**
- `src/features/contractor-pro/ContractorProApp.jsx` - Add recurring section/tab
- `src/features/contractor-pro/components/DragDropCalendar.jsx` - Show recurring badge
- `src/features/contractor-pro/components/TeamCalendarView.jsx` - Show recurring badge

---

## Phase 3: Homeowner Experience

### 3.1 Active Projects Section Enhancement
**Where:** ModernDashboard.jsx → ActiveProjectsSection

**Changes:**
- Add new "Recurring Services" subsection OR integrate into "Active Projects"
- Show upcoming scheduled recurring visits
- Clear visual distinction with repeat icon

**Card Display:**
```
┌────────────────────────────────────────────┐
│ ↻ Lawn Care                    Every 2 wks │
│ ABC Landscaping                            │
│                                            │
│ Next visit: Tue, Jan 21 @ 9:00 AM          │
│ ─────────────────────────────────────────  │
│ [Skip Next]  [Pause Service]  [Manage →]   │
└────────────────────────────────────────────┘
```

### 3.2 Homeowner Actions
- **Skip Next:** Skip one occurrence, series continues
- **Pause Service:** Temporarily stop (with resume date option)
- **Reschedule Next:** Move just the next occurrence
- **Cancel Service:** End the recurring agreement

### 3.3 New Section: "My Services"
**Option A:** Integrate into "Active Projects"
- Recurring services appear at top with ↻ badge
- One-time jobs appear below

**Option B:** Separate "Recurring Services" section
- Dedicated collapsible section
- Shows service name, contractor, frequency, next date

**Recommendation:** Option A (simpler, less UI clutter)

**Files to Modify:**
- `src/features/dashboard/ModernDashboard.jsx` - Add recurring display
- `src/features/jobs/HomeownerJobCard.jsx` - Add recurring badge/styling
- New: `src/features/recurring/components/RecurringServiceManager.jsx` - Homeowner management modal

---

## Phase 4: Auto-Generation Logic

### 4.1 Job Generation Strategy
**Rolling Window Approach:**
- System maintains next 2 upcoming job instances at all times
- After a job completes → auto-create the next one
- Never create more than 2 months ahead

### 4.2 Generation Trigger Points
1. **On recurring service creation:** Generate first 2 instances
2. **On job completion:** Generate next instance
3. **Daily cron/cloud function:** Fill gaps, handle edge cases

### 4.3 Implementation
```javascript
// recurringService.js

export const generateNextInstance = async (recurringServiceId) => {
  const service = await getRecurringService(recurringServiceId);
  if (service.status !== 'active') return null;

  const nextDate = calculateNextDate(service);

  // Create job document
  const jobData = {
    contractorId: service.contractorId,
    customerId: service.customerId,
    propertyId: service.propertyId,
    title: service.serviceName,
    description: service.description,
    estimatedDuration: service.estimatedDuration,
    estimate: { total: service.basePrice },
    scheduledDate: nextDate,
    scheduledTime: combineDateTime(nextDate, service.preferredTime),
    assignedTechId: service.assignedTechId,
    status: 'scheduled',
    recurring: {
      isRecurring: true,
      serviceId: recurringServiceId,
      instanceNumber: service.totalCompletedJobs + 1,
      isAutoGenerated: true
    }
  };

  // Create job and update service
  const jobRef = await addDoc(collection(db, REQUESTS_COLLECTION_PATH), jobData);
  await updateDoc(doc(db, RECURRING_SERVICES_PATH, recurringServiceId), {
    nextScheduledDate: nextDate,
    updatedAt: serverTimestamp()
  });

  return jobRef.id;
};
```

---

## Phase 5: Billing Integration (Future)

### 5.1 Per-Visit Billing (Default)
- Same as one-time jobs
- Invoice generated after each completed visit
- Customer pays per occurrence

### 5.2 Monthly Subscription (Future Enhancement)
- Stripe subscription mode
- Fixed monthly charge regardless of visit count
- Better for high-frequency services

**Not in initial scope** - start with per-visit billing.

---

## Implementation Order

### Sprint 1: Core Infrastructure
1. Create `RECURRING_SERVICES_COLLECTION_PATH` constant
2. Create `recurringService.js` with CRUD operations
3. Create `useRecurringServices.js` hooks
4. Add recurring fields to job creation flow

### Sprint 2: Contractor UI
5. Create `CreateRecurringServiceModal.jsx`
6. Add "Make recurring" option after job completion
7. Add recurring badge to calendar components
8. Create recurring services management section

### Sprint 3: Homeowner UI
9. Enhance `HomeownerJobCard.jsx` with recurring styling
10. Add recurring services to `ModernDashboard.jsx`
11. Create `RecurringServiceManager.jsx` for homeowner actions
12. Add Skip/Pause/Cancel functionality

### Sprint 4: Auto-Generation
13. Implement `generateNextInstance()` logic
14. Add generation triggers (on complete, on create)
15. Test edge cases (paused services, cancelled, etc.)

---

## UI/UX Guidelines

### Visual Indicators
- **Repeat icon:** ↻ (RotateCcw from lucide)
- **Badge color:** Use existing status colors + repeat icon
- **Frequency label:** "Weekly", "Every 2 wks", "Monthly"

### Frequency Options (Keep Simple)
```javascript
const FREQUENCY_OPTIONS = [
  { value: 'weekly', label: 'Weekly', days: 7 },
  { value: 'biweekly', label: 'Every 2 weeks', days: 14 },
  { value: 'monthly', label: 'Monthly', days: 30 },
  { value: 'quarterly', label: 'Quarterly', days: 90 },
];
```

### Status States
- **Active:** Green, showing next date
- **Paused:** Yellow/amber, showing "Paused until [date]"
- **Cancelled:** Red/gray, archived

---

## Summary

**Total New Files:** ~6
**Modified Files:** ~6
**Estimated Effort:** 3 sprints

**Key Simplifications:**
- No Stripe subscriptions initially (per-visit billing only)
- Rolling 2-instance window (not 52 jobs upfront)
- Integrated into existing "Active Projects" (no separate section)
- Same job data model (just adds `recurring` field)
